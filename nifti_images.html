<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Neuroimaging in Python &#8212; NiBabel 5.4.0.dev1+g3b1c7b37 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/nibabel.css?v=f6107aeb" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="_static/plot_directive.css" />
    <script src="_static/documentation_options.js?v=8f87c9ba"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Image voxel orientation" href="image_orientation.html" />
    <link rel="prev" title="Images and memory" href="images_and_memory.html" />
  <meta name="keywords" content="nipy, neuroimaging, python, neuroscience">

  </head><body>
<div class="row" style="display: flex; flex-direction: row; flex-wrap: wrap; width: 100%;">
  <div class="column" style="background-color: white; display: flex; flex-direction: column; flex: 0 0 140px; padding-left: 2px; padding-bottom:2px; padding-top:2px;">
    <img src="_static/nibabel-logo.svg" class="logo" alt="Logo" width="130px"/>
  </div>
  <div class="column" style="background-color: white; text-align: left; padding-left: 10px; padding-bottom:50px; padding-top:20px; background-repeat: no-repeat; display: flex; flex-direction: column; flex-basis: 100%; flex: 1;">
    <h1>NiBabel</h1>
    <h3 style="margin-top:-5px;color:#2f83c8">Access a cacophony of neuro-imaging file formats</h3>
  </div>
</div>

    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="image_orientation.html" title="Image voxel orientation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="images_and_memory.html" title="Images and memory"
             accesskey="P">previous</a> |</li>
  <li><a href="http://nipy.org/">Community</a> |&nbsp;</li>
  <li><a href="index.html">NiBabel Home</a> |&nbsp;</li>
  <li><a href="https://mail.python.org/mailman/listinfo/neuroimaging">Mailing list</a> |&nbsp;</li>
  <li><a href="legal.html">License</a> |&nbsp;</li>

          <li class="nav-item nav-item-1"><a href="manual.html" accesskey="U">NiBabel Manual</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Neuroimaging in Python</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Working with NIfTI images</a><ul>
<li><a class="reference internal" href="#preliminaries">Preliminaries</a></li>
<li><a class="reference internal" href="#example-nifti-images">Example NIfTI images</a></li>
<li><a class="reference internal" href="#the-nifti-header">The NIfTI header</a></li>
<li><a class="reference internal" href="#the-nifti-affines">The NIfTI affines</a><ul>
<li><a class="reference internal" href="#the-sform-affine">The sform affine</a></li>
<li><a class="reference internal" href="#the-qform-affine">The qform affine</a></li>
<li><a class="reference internal" href="#the-fall-back-header-affine">The fall-back header affine</a></li>
<li><a class="reference internal" href="#choosing-the-image-affine">Choosing the image affine</a></li>
<li><a class="reference internal" href="#default-sform-and-qform-codes">Default sform and qform codes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#data-scaling">Data scaling</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="images_and_memory.html"
                          title="previous chapter">Images and memory</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="image_orientation.html"
                          title="next chapter">Image voxel orientation</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/nifti_images.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="working-with-nifti-images">
<h1>Working with NIfTI images<a class="headerlink" href="#working-with-nifti-images" title="Link to this heading">¶</a></h1>
<p>This page describes some features of the nibabel implementation of the NIfTI
format.  Generally all these features apply equally to the NIfTI 1 and the
NIfTI 2 format, but we will note the differences when they come up.  NIfTI 1
is much more common than NIfTI 2.</p>
<section id="preliminaries">
<h2>Preliminaries<a class="headerlink" href="#preliminaries" title="Link to this heading">¶</a></h2>
<p>We first set some display parameters to print out numpy arrays in a compact
form:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Set numpy to print only 2 decimal digits for neatness</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="example-nifti-images">
<h2>Example NIfTI images<a class="headerlink" href="#example-nifti-images" title="Link to this heading">¶</a></h2>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">os</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">nibabel.testing</span> <span class="kn">import</span> <span class="n">data_path</span>
</pre></div>
</div>
<p>This is the example NIfTI 1 image:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">example_ni1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;example4d.nii.gz&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n1_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">example_ni1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n1_img</span>
<span class="go">&lt;nibabel.nifti1.Nifti1Image object at ...&gt;</span>
</pre></div>
</div>
<p>Here is the NIfTI 2 example image:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">example_ni2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;example_nifti2.nii.gz&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n2_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">example_ni2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n2_img</span>
<span class="go">&lt;nibabel.nifti2.Nifti2Image object at ...&gt;</span>
</pre></div>
</div>
</section>
<section id="the-nifti-header">
<h2>The NIfTI header<a class="headerlink" href="#the-nifti-header" title="Link to this heading">¶</a></h2>
<p>The NIfTI 1 header is a small C structure of size 352 bytes.  It contains the
following fields:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">n1_header</span> <span class="o">=</span> <span class="n">n1_img</span><span class="o">.</span><span class="n">header</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">n1_header</span><span class="p">)</span>                     
<span class="go">&lt;class &#39;nibabel.nifti1.Nifti1Header&#39;&gt; object, endian=&#39;&lt;&#39;</span>
<span class="go">sizeof_hdr      : 348</span>
<span class="go">data_type       : b&#39;&#39;</span>
<span class="go">db_name         : b&#39;&#39;</span>
<span class="go">extents         : 0</span>
<span class="go">session_error   : 0</span>
<span class="go">regular         : b&#39;r&#39;</span>
<span class="go">dim_info        : 57</span>
<span class="go">dim             : [  4 128  96  24   2   1   1   1]</span>
<span class="go">intent_p1       : 0.0</span>
<span class="go">intent_p2       : 0.0</span>
<span class="go">intent_p3       : 0.0</span>
<span class="go">intent_code     : none</span>
<span class="go">datatype        : int16</span>
<span class="go">bitpix          : 16</span>
<span class="go">slice_start     : 0</span>
<span class="go">pixdim          : [   -1.      2.      2.      2.2  2000.      1.      1.      1. ]</span>
<span class="go">vox_offset      : 0.0</span>
<span class="go">scl_slope       : nan</span>
<span class="go">scl_inter       : nan</span>
<span class="go">slice_end       : 23</span>
<span class="go">slice_code      : unknown</span>
<span class="go">xyzt_units      : 10</span>
<span class="go">cal_max         : 1162.0</span>
<span class="go">cal_min         : 0.0</span>
<span class="go">slice_duration  : 0.0</span>
<span class="go">toffset         : 0.0</span>
<span class="go">glmax           : 0</span>
<span class="go">glmin           : 0</span>
<span class="go">descrip         : b&#39;FSL3.3\x00 v2.25 NIfTI-1 Single file format&#39;</span>
<span class="go">aux_file        : b&#39;&#39;</span>
<span class="go">qform_code      : scanner</span>
<span class="go">sform_code      : scanner</span>
<span class="go">quatern_b       : -1.94510681403e-26</span>
<span class="go">quatern_c       : -0.996708512306</span>
<span class="go">quatern_d       : -0.081068739295</span>
<span class="go">qoffset_x       : 117.855102539</span>
<span class="go">qoffset_y       : -35.7229423523</span>
<span class="go">qoffset_z       : -7.24879837036</span>
<span class="go">srow_x          : [  -2.      0.      0.    117.86]</span>
<span class="go">srow_y          : [ -0.     1.97  -0.36 -35.72]</span>
<span class="go">srow_z          : [ 0.    0.32  2.17 -7.25]</span>
<span class="go">intent_name     : b&#39;&#39;</span>
<span class="go">magic           : b&#39;n+1&#39;</span>
</pre></div>
</div>
<p>The NIfTI 2 header is similar, but of length 540 bytes, with fewer fields:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">n2_header</span> <span class="o">=</span> <span class="n">n2_img</span><span class="o">.</span><span class="n">header</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">n2_header</span><span class="p">)</span>                     
<span class="go">    &lt;class &#39;nibabel.nifti2.Nifti2Header&#39;&gt; object, endian=&#39;&lt;&#39;</span>
<span class="go">    sizeof_hdr      : 540</span>
<span class="go">    magic           : b&#39;n+2&#39;</span>
<span class="go">    eol_check       : [13 10 26 10]</span>
<span class="go">    datatype        : int16</span>
<span class="go">    bitpix          : 16</span>
<span class="go">    dim             : [ 4 32 20 12  2  1  1  1]</span>
<span class="go">    intent_p1       : 0.0</span>
<span class="go">    intent_p2       : 0.0</span>
<span class="go">    intent_p3       : 0.0</span>
<span class="go">    pixdim          : [   -1.      2.      2.      2.2  2000.      1.      1.      1. ]</span>
<span class="go">    vox_offset      : 0</span>
<span class="go">    scl_slope       : nan</span>
<span class="go">    scl_inter       : nan</span>
<span class="go">    cal_max         : 1162.0</span>
<span class="go">    cal_min         : 0.0</span>
<span class="go">    slice_duration  : 0.0</span>
<span class="go">    toffset         : 0.0</span>
<span class="go">    slice_start     : 0</span>
<span class="go">    slice_end       : 23</span>
<span class="go">    descrip         : b&#39;FSL3.3\x00 v2.25 NIfTI-1 Single file format&#39;</span>
<span class="go">    aux_file        : b&#39;&#39;</span>
<span class="go">    qform_code      : scanner</span>
<span class="go">    sform_code      : scanner</span>
<span class="go">    quatern_b       : -1.94510681403e-26</span>
<span class="go">    quatern_c       : -0.996708512306</span>
<span class="go">    quatern_d       : -0.081068739295</span>
<span class="go">    qoffset_x       : 117.855102539</span>
<span class="go">    qoffset_y       : -35.7229423523</span>
<span class="go">    qoffset_z       : -7.24879837036</span>
<span class="go">    srow_x          : [  -2.      0.      0.    117.86]</span>
<span class="go">    srow_y          : [ -0.     1.97  -0.36 -35.72]</span>
<span class="go">    srow_z          : [ 0.    0.32  2.17 -7.25]</span>
<span class="go">    slice_code      : unknown</span>
<span class="go">    xyzt_units      : 10</span>
<span class="go">    intent_code     : none</span>
<span class="go">    intent_name     : b&#39;&#39;</span>
<span class="go">    dim_info        : 57</span>
<span class="go">    unused_str      : b&#39;&#39;</span>
</pre></div>
</div>
<p>You can get and set individual fields in the header using dict (mapping-type)
item access.  For example:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">n1_header</span><span class="p">[</span><span class="s1">&#39;cal_max&#39;</span><span class="p">]</span>
<span class="go">array(1162., dtype=float32)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n1_header</span><span class="p">[</span><span class="s1">&#39;cal_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1200</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n1_header</span><span class="p">[</span><span class="s1">&#39;cal_max&#39;</span><span class="p">]</span>
<span class="go">array(1200., dtype=float32)</span>
</pre></div>
</div>
<p>Check the attributes of the header for <code class="docutils literal notranslate"><span class="pre">get_</span></code> / <code class="docutils literal notranslate"><span class="pre">set_</span></code> methods to get and
set various combinations of NIfTI header fields.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">get_</span></code> / <code class="docutils literal notranslate"><span class="pre">set_</span></code> methods should check and apply valid combinations of
values from the header, whereas you can do anything you like with the dict /
mapping item access.  It is safer to use the <code class="docutils literal notranslate"><span class="pre">get_</span></code> / <code class="docutils literal notranslate"><span class="pre">set_</span></code> methods and
use the mapping item access only if the <code class="docutils literal notranslate"><span class="pre">get_</span></code> / <code class="docutils literal notranslate"><span class="pre">set_</span></code> methods will not
do what you want.</p>
</section>
<section id="the-nifti-affines">
<h2>The NIfTI affines<a class="headerlink" href="#the-nifti-affines" title="Link to this heading">¶</a></h2>
<p>Like other nibabel image types, NIfTI images have an affine relating the voxel
coordinates to world coordinates in RAS+ space:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">n1_img</span><span class="o">.</span><span class="n">affine</span>
<span class="go">array([[ -2.  ,   0.  ,   0.  , 117.86],</span>
<span class="go">       [ -0.  ,   1.97,  -0.36, -35.72],</span>
<span class="go">       [  0.  ,   0.32,   2.17,  -7.25],</span>
<span class="go">       [  0.  ,   0.  ,   0.  ,   1.  ]])</span>
</pre></div>
</div>
<p>Unlike other formats, the NIfTI header format can specify this affine in one
of three ways — the <em>sform</em> affine, the <em>qform</em> affine and the <em>fall-back
header</em> affine.</p>
<p>Nibabel uses an <a class="reference internal" href="#choosing-image-affine"><span class="std std-ref">algorithm</span></a> to chose which of
these three it will use for the overall image <code class="docutils literal notranslate"><span class="pre">affine</span></code>.</p>
<section id="the-sform-affine">
<h3>The sform affine<a class="headerlink" href="#the-sform-affine" title="Link to this heading">¶</a></h3>
<p>The header stores the three first rows of the 4 by 4 affine in the header
fields <code class="docutils literal notranslate"><span class="pre">srow_x</span></code>, <code class="docutils literal notranslate"><span class="pre">srow_y</span></code>, <code class="docutils literal notranslate"><span class="pre">srow_z</span></code>. The header does not store the
fourth row because it is always <code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">0,</span> <span class="pre">0,</span> <span class="pre">1]</span></code> (see
<a class="reference internal" href="coordinate_systems.html"><span class="doc">Coordinate systems and affines</span></a>).</p>
<p>You can get the sform affine specifically with the <code class="docutils literal notranslate"><span class="pre">get_sform()</span></code> method of
the image or the header.</p>
<p>For example:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">n1_header</span><span class="p">[</span><span class="s1">&#39;srow_x&#39;</span><span class="p">])</span>
<span class="go">[ -2.     0.     0.   117.86]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">n1_header</span><span class="p">[</span><span class="s1">&#39;srow_y&#39;</span><span class="p">])</span>
<span class="go">[ -0.     1.97  -0.36 -35.72]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">n1_header</span><span class="p">[</span><span class="s1">&#39;srow_z&#39;</span><span class="p">])</span>
<span class="go">[ 0.    0.32  2.17 -7.25]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">n1_header</span><span class="o">.</span><span class="n">get_sform</span><span class="p">())</span>
<span class="go">[[ -2.     0.     0.   117.86]</span>
<span class="go"> [ -0.     1.97  -0.36 -35.72]</span>
<span class="go"> [  0.     0.32   2.17  -7.25]</span>
<span class="go"> [  0.     0.     0.     1.  ]]</span>
</pre></div>
</div>
<p>This affine is valid only if the <code class="docutils literal notranslate"><span class="pre">sform_code</span></code> is not zero.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">n1_header</span><span class="p">[</span><span class="s1">&#39;sform_code&#39;</span><span class="p">])</span>
<span class="go">1</span>
</pre></div>
</div>
<p>The different sform code values specify which RAS+ space the sform affine
refers to, with these interpretations:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Code</p></th>
<th class="head"><p>Label</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>unknown</p></td>
<td><p>sform not defined</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>scanner</p></td>
<td><p>RAS+ in scanner coordinates</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>aligned</p></td>
<td><p>RAS+ aligned to some other scan</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>talairach</p></td>
<td><p>RAS+ in Talairach atlas space</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>mni</p></td>
<td><p>RAS+ in MNI atlas space</p></td>
</tr>
</tbody>
</table>
<p>In our case the code is 1, meaning “scanner” alignment.</p>
<p>You can get the affine and the code using the <code class="docutils literal notranslate"><span class="pre">coded=True</span></code> argument to
<code class="docutils literal notranslate"><span class="pre">get_sform()</span></code>:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">n1_header</span><span class="o">.</span><span class="n">get_sform</span><span class="p">(</span><span class="n">coded</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="go">(array([[ -2.  ,   0.  ,   0.  , 117.86],</span>
<span class="go">       [ -0.  ,   1.97,  -0.36, -35.72],</span>
<span class="go">       [  0.  ,   0.32,   2.17,  -7.25],</span>
<span class="go">       [  0.  ,   0.  ,   0.  ,   1.  ]]), 1)</span>
</pre></div>
</div>
<p>You can set the sform with the <code class="docutils literal notranslate"><span class="pre">set_sform()</span></code> method of the header and
the image.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">n1_header</span><span class="o">.</span><span class="n">set_sform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n1_header</span><span class="o">.</span><span class="n">get_sform</span><span class="p">()</span>
<span class="go">array([[2., 0., 0., 0.],</span>
<span class="go">       [0., 3., 0., 0.],</span>
<span class="go">       [0., 0., 4., 0.],</span>
<span class="go">       [0., 0., 0., 1.]])</span>
</pre></div>
</div>
<p>Set the affine and code using the <code class="docutils literal notranslate"><span class="pre">code</span></code> parameter to <code class="docutils literal notranslate"><span class="pre">set_sform()</span></code>:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">n1_header</span><span class="o">.</span><span class="n">set_sform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">code</span><span class="o">=</span><span class="s1">&#39;mni&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n1_header</span><span class="o">.</span><span class="n">get_sform</span><span class="p">(</span><span class="n">coded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="go">(array([[3., 0., 0., 0.],</span>
<span class="go">       [0., 4., 0., 0.],</span>
<span class="go">       [0., 0., 5., 0.],</span>
<span class="go">       [0., 0., 0., 1.]]), 4)</span>
</pre></div>
</div>
</section>
<section id="the-qform-affine">
<h3>The qform affine<a class="headerlink" href="#the-qform-affine" title="Link to this heading">¶</a></h3>
<p>This affine can be calculated from a combination of the voxel sizes (entries 1
through 4 of the <code class="docutils literal notranslate"><span class="pre">pixdim</span></code> field), a sign flip called <code class="docutils literal notranslate"><span class="pre">qfac</span></code> stored in
entry 0 of <code class="docutils literal notranslate"><span class="pre">pixdim</span></code>, and a <a class="reference external" href="https://en.wikipedia.org/wiki/Quaternion">quaternion</a> that can be
reconstructed from fields <code class="docutils literal notranslate"><span class="pre">quatern_b</span></code>, <code class="docutils literal notranslate"><span class="pre">quatern_c</span></code>, <code class="docutils literal notranslate"><span class="pre">quatern_d</span></code>.</p>
<p>See the code for the <a class="reference internal" href="reference/nibabel.nifti1.html#nibabel.nifti1.Nifti1Header.get_qform" title="nibabel.nifti1.Nifti1Header.get_qform"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_qform()</span> <span class="pre">method</span></code></a> for details.</p>
<p>You can get and set the qform affine using the equivalent methods to those for
the sform: <code class="docutils literal notranslate"><span class="pre">get_qform()</span></code>, <code class="docutils literal notranslate"><span class="pre">set_qform()</span></code>.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">n1_header</span><span class="o">.</span><span class="n">get_qform</span><span class="p">(</span><span class="n">coded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="go">(array([[ -2.  ,   0.  ,  -0.  , 117.86],</span>
<span class="go">       [  0.  ,   1.97,  -0.36, -35.72],</span>
<span class="go">       [  0.  ,   0.32,   2.17,  -7.25],</span>
<span class="go">       [  0.  ,   0.  ,   0.  ,   1.  ]]), 1)</span>
</pre></div>
</div>
<p>The qform also has a corresponding <code class="docutils literal notranslate"><span class="pre">qform_code</span></code> with the same interpretation
as the <cite>sform_code</cite>.</p>
</section>
<section id="the-fall-back-header-affine">
<h3>The fall-back header affine<a class="headerlink" href="#the-fall-back-header-affine" title="Link to this heading">¶</a></h3>
<p>This is the affine of last resort, constructed only from the <code class="docutils literal notranslate"><span class="pre">pixdim</span></code> voxel
sizes.  The <a class="reference external" href="nifti1">NIfTI specification</a> says that this should set the
first voxel in the image as [0, 0, 0] in world coordinates, but we nibabblers
follow <a class="reference external" href="http://www.fil.ion.ucl.ac.uk/spm">SPM</a> in preferring to set the central voxel to have [0, 0, 0] world
coordinate. The NIfTI spec also implies that the image should be assumed to be
in RAS+ <em>voxel</em> orientation for this affine (see <a class="reference internal" href="coordinate_systems.html"><span class="doc">Coordinate systems and affines</span></a>).
Again like SPM, we prefer to assume LAS+ voxel orientation by default.</p>
<p>You can always get the fall-back affine with <code class="docutils literal notranslate"><span class="pre">get_base_affine()</span></code>:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">n1_header</span><span class="o">.</span><span class="n">get_base_affine</span><span class="p">()</span>
<span class="go">array([[ -2. ,   0. ,   0. , 127. ],</span>
<span class="go">       [  0. ,   2. ,   0. , -95. ],</span>
<span class="go">       [  0. ,   0. ,   2.2, -25.3],</span>
<span class="go">       [  0. ,   0. ,   0. ,   1. ]])</span>
</pre></div>
</div>
</section>
<section id="choosing-the-image-affine">
<span id="choosing-image-affine"></span><h3>Choosing the image affine<a class="headerlink" href="#choosing-the-image-affine" title="Link to this heading">¶</a></h3>
<p>Given there are three possible affines defined in the NIfTI header, nibabel
has to chose which of these to use for the image <code class="docutils literal notranslate"><span class="pre">affine</span></code>.</p>
<p>The algorithm is defined in the <code class="docutils literal notranslate"><span class="pre">get_best_affine()</span></code> method.  It is:</p>
<ol class="arabic simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">sform_code</span></code> != 0 (‘unknown’) use the sform affine; else</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">qform_code</span></code> != 0 (‘unknown’) use the qform affine; else</p></li>
<li><p>Use the fall-back affine.</p></li>
</ol>
</section>
<section id="default-sform-and-qform-codes">
<span id="default-sform-qform-codes"></span><h3>Default sform and qform codes<a class="headerlink" href="#default-sform-and-qform-codes" title="Link to this heading">¶</a></h3>
<p>If you create a new image, e.g.:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">xform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">nifti1</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">xform</span><span class="p">)</span>
</pre></div>
</div>
<p>The sform and qform codes will be initialised to 2 (aligned) and 0 (unknown)
respectively:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">img</span><span class="o">.</span><span class="n">get_sform</span><span class="p">(</span><span class="n">coded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
<span class="go">(array([[2., 0., 0., 0.],</span>
<span class="go">       [0., 2., 0., 0.],</span>
<span class="go">       [0., 0., 2., 0.],</span>
<span class="go">       [0., 0., 0., 1.]]), 2)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">img</span><span class="o">.</span><span class="n">get_qform</span><span class="p">(</span><span class="n">coded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="go">(None, 0)</span>
</pre></div>
</div>
<p>This is based on the assumption that the affine you specify for a newly
created image will align the image to some known coordinate system. According
to the <a class="reference external" href="nifti1">NIfTI specification</a>, the qform is intended to encode a
transformation into scanner coordinates - for a programmatically created
image, we have no way of knowing what the scanner coordinate system is;
furthermore, the qform cannot be used to store an arbitrary affine transform,
as it is unable to encode shears. So the provided affine will be stored in the
sform, and the qform will be left uninitialised.</p>
<p>If you create a new image and specify an existing header, e.g.:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">example_ni1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;example4d.nii.gz&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n1_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">example_ni1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">new_header</span> <span class="o">=</span> <span class="n">header</span><span class="o">=</span><span class="n">n1_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">new_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n1_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">new_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">nifti1</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">new_header</span><span class="p">)</span>
</pre></div>
</div>
<p>then the newly created image will inherit the same sform and qform codes that
are in the provided header. However, if you create a new image with both an
affine and a header specified, e.g.:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">xform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">new_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">nifti1</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">xform</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">new_header</span><span class="p">)</span>
</pre></div>
</div>
<p>then the sform and qform codes will <em>only</em> be preserved if the provided affine
is the same as the affine in the provided header. If the affines do not match,
the sform and qform codes will be set to their default values of 2 and 0
respectively. This is done on the basis that, if you are changing the affine,
you are likely to be changing the space to which the affine is pointing. So
the original sform and qform codes can no longer be assumed to be valid.</p>
<p>If you wish to set the sform and qform affines and/or codes to some other
value, you can always set them after creation using the <code class="docutils literal notranslate"><span class="pre">set_sform</span></code> and
<code class="docutils literal notranslate"><span class="pre">set_qform</span></code> methods, as described above.</p>
</section>
</section>
<section id="data-scaling">
<h2>Data scaling<a class="headerlink" href="#data-scaling" title="Link to this heading">¶</a></h2>
<p>NIfTI uses a simple scheme for data scaling.</p>
<p>By default, nibabel will take care of this scaling for you, but there may be
times that you want to control the data scaling yourself.  If so, the next
section describes how the scaling works and the nibabel implementation of
same.</p>
<p>There are two scaling fields in the header called <code class="docutils literal notranslate"><span class="pre">scl_slope</span></code> and
<code class="docutils literal notranslate"><span class="pre">scl_inter</span></code>.</p>
<p>The output data from a NIfTI image comes from:</p>
<ol class="arabic simple">
<li><p>Loading the binary data from the image file;</p></li>
<li><p>Casting the numbers to the binary format given in the header and returned
by <code class="docutils literal notranslate"><span class="pre">get_data_dtype()</span></code>;</p></li>
<li><p>Reshaping to the output image shape;</p></li>
<li><p>Multiplying the result by the header <code class="docutils literal notranslate"><span class="pre">scl_slope</span></code> value, if
both of <code class="docutils literal notranslate"><span class="pre">scl_slope</span></code> and <code class="docutils literal notranslate"><span class="pre">scl_inter</span></code> are defined;</p></li>
<li><p>Adding the value header <code class="docutils literal notranslate"><span class="pre">scl_inter</span></code> value to the result, if both of
<code class="docutils literal notranslate"><span class="pre">scl_slope</span></code> and <code class="docutils literal notranslate"><span class="pre">scl_inter</span></code> are defined;</p></li>
</ol>
<p>‘Defined’ means, the value is not NaN (not a number).</p>
<p>All this gets built into the array proxy when you load a NIfTI image.</p>
<p>When you load an image, the header scaling values automatically get set to NaN
(undefined) to mark the fact that the scaling values have been consumed by the
read.  The scaling values read from the header on load only appear in the
array proxy object.</p>
<p>To see how this works, let’s make a new image with some scaling:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">array_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">affine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">array_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">array_data</span><span class="p">,</span> <span class="n">affine</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">array_header</span> <span class="o">=</span> <span class="n">array_img</span><span class="o">.</span><span class="n">header</span>
</pre></div>
</div>
<p>The default scaling values are NaN (undefined):</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">array_header</span><span class="p">[</span><span class="s1">&#39;scl_slope&#39;</span><span class="p">]</span>
<span class="go">array(nan, dtype=float32)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">array_header</span><span class="p">[</span><span class="s1">&#39;scl_inter&#39;</span><span class="p">]</span>
<span class="go">array(nan, dtype=float32)</span>
</pre></div>
</div>
<p>You can get the scaling values with the <code class="docutils literal notranslate"><span class="pre">get_slope_inter()</span></code> method:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">array_header</span><span class="o">.</span><span class="n">get_slope_inter</span><span class="p">()</span>
<span class="go">(None, None)</span>
</pre></div>
</div>
<p>None corresponds to the NaN scaling value (undefined).</p>
<p>We can set them in the image header, so they get saved to the header when the
image is written.  We can do this by setting the fields directly, or with
<code class="docutils literal notranslate"><span class="pre">set_slope_inter()</span></code>:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">array_header</span><span class="o">.</span><span class="n">set_slope_inter</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">array_header</span><span class="o">.</span><span class="n">get_slope_inter</span><span class="p">()</span>
<span class="go">(2.0, 10.0)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">array_header</span><span class="p">[</span><span class="s1">&#39;scl_slope&#39;</span><span class="p">]</span>
<span class="go">array(2., dtype=float32)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">array_header</span><span class="p">[</span><span class="s1">&#39;scl_inter&#39;</span><span class="p">]</span>
<span class="go">array(10., dtype=float32)</span>
</pre></div>
</div>
<p>Setting the scale factors in the header has no effect on the image data before
we save and load again:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">array_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
<span class="go">array([[[ 0.,  1.,  2.,  3.],</span>
<span class="go">        [ 4.,  5.,  6.,  7.],</span>
<span class="go">        [ 8.,  9., 10., 11.]],</span>

<span class="go">       [[12., 13., 14., 15.],</span>
<span class="go">        [16., 17., 18., 19.],</span>
<span class="go">        [20., 21., 22., 23.]]])</span>
</pre></div>
</div>
<p>Now we save the image and load it again:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">array_img</span><span class="p">,</span> <span class="s1">&#39;scaled_image.nii&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">scaled_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;scaled_image.nii&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The data array has the scaling applied:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">scaled_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
<span class="go">array([[[10., 12., 14., 16.],</span>
<span class="go">        [18., 20., 22., 24.],</span>
<span class="go">        [26., 28., 30., 32.]],</span>

<span class="go">       [[34., 36., 38., 40.],</span>
<span class="go">        [42., 44., 46., 48.],</span>
<span class="go">        [50., 52., 54., 56.]]])</span>
</pre></div>
</div>
<p>The header for the loaded image has had the scaling reset to undefined, to
mark the fact that the scaling has been “consumed” by the load:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">scaled_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_slope_inter</span><span class="p">()</span>
<span class="go">(None, None)</span>
</pre></div>
</div>
<p>The original slope and intercept are still accessible in the array proxy
object:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">scaled_img</span><span class="o">.</span><span class="n">dataobj</span><span class="o">.</span><span class="n">slope</span>
<span class="go">2.0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">scaled_img</span><span class="o">.</span><span class="n">dataobj</span><span class="o">.</span><span class="n">inter</span>
<span class="go">10.0</span>
</pre></div>
</div>
<p>If the header scaling is undefined when we save the image, nibabel will try to
find an optimum slope and intercept to best preserve the precision of the data
in the output data type.  Because nibabel will set the scaling to undefined
when loading the image, or creating a new image, this is the default behavior.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2006, NiBabel developers &lt;neuroimaging@python.org&gt;.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.0.2.
    </div>
  </body>
</html>