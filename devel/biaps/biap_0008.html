<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Neuroimaging in Python &#8212; NiBabel 5.4.0.dev1+g3b1c7b37 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/nibabel.css?v=f6107aeb" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <script src="../../_static/documentation_options.js?v=8f87c9ba"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="BIAP9 - The Coordinate Image API" href="biap_0009.html" />
    <link rel="prev" title="BIAP7 - Loading multiple images" href="biap_0007.html" />
  <meta name="keywords" content="nipy, neuroimaging, python, neuroscience">

  </head><body>
<div class="row" style="display: flex; flex-direction: row; flex-wrap: wrap; width: 100%;">
  <div class="column" style="background-color: white; display: flex; flex-direction: column; flex: 0 0 140px; padding-left: 2px; padding-bottom:2px; padding-top:2px;">
    <img src="../../_static/nibabel-logo.svg" class="logo" alt="Logo" width="130px"/>
  </div>
  <div class="column" style="background-color: white; text-align: left; padding-left: 10px; padding-bottom:50px; padding-top:20px; background-repeat: no-repeat; display: flex; flex-direction: column; flex-basis: 100%; flex: 1;">
    <h1>NiBabel</h1>
    <h3 style="margin-top:-5px;color:#2f83c8">Access a cacophony of neuro-imaging file formats</h3>
  </div>
</div>

    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="biap_0009.html" title="BIAP9 - The Coordinate Image API"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="biap_0007.html" title="BIAP7 - Loading multiple images"
             accesskey="P">previous</a> |</li>
  <li><a href="http://nipy.org/">Community</a> |&nbsp;</li>
  <li><a href="../../index.html">NiBabel Home</a> |&nbsp;</li>
  <li><a href="https://mail.python.org/mailman/listinfo/neuroimaging">Mailing list</a> |&nbsp;</li>
  <li><a href="legal.html">License</a> |&nbsp;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Developer documentation page</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">BIAPs</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Neuroimaging in Python</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">BIAP8 - Always load image data as floating point</a><ul>
<li><a class="reference internal" href="#background">Background</a><ul>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#in-detail">In detail</a></li>
<li><a class="reference internal" href="#current-implementation">Current implementation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#proposal-add-prefer-get-fdata-method">Proposal - add, prefer <code class="docutils literal notranslate"><span class="pre">get_fdata</span></code> method</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="biap_0007.html"
                          title="previous chapter">BIAP7 - Loading multiple images</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="biap_0009.html"
                          title="next chapter">BIAP9 - The Coordinate Image API</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/devel/biaps/biap_0008.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="biap8-always-load-image-data-as-floating-point">
<span id="biap8"></span><h1>BIAP8 - Always load image data as floating point<a class="headerlink" href="#biap8-always-load-image-data-as-floating-point" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd"><p>Matthew Brett</p>
</dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><p>Accepted</p>
</dd>
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Standards</p>
</dd>
<dt class="field-even">Created<span class="colon">:</span></dt>
<dd class="field-even"><p>2018-04-18</p>
</dd>
</dl>
<p><code class="docutils literal notranslate"><span class="pre">get_fdata</span></code> shipped as of nibabel 2.2.0.</p>
<p>See <a class="reference external" href="https://mail.python.org/pipermail/neuroimaging/2015-July/thread.html#21">this mailing list thread</a> for discussion on an earlier version of this proposal.</p>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">¶</a></h2>
<section id="summary">
<h3>Summary<a class="headerlink" href="#summary" title="Link to this heading">¶</a></h3>
<p>The problem with our current <code class="docutils literal notranslate"><span class="pre">get_data</span></code> method is that the returned data
type is difficult to predict, and can switch between integer and floating
point types depending on values in the image header.</p>
<p>The underlying problem is that the author and the user of a given NIfTI image
would be unlikely to expect that the scalefactors of the NIfTI header (which
the user will probably not be aware of) will affect the calculations done on
the image data after loading into memory.</p>
</section>
<section id="in-detail">
<h3>In detail<a class="headerlink" href="#in-detail" title="Link to this heading">¶</a></h3>
<p>At the moment, if you do this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;my_image.nii&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
</pre></div>
</div>
<p>then the data type (dtype) of the returned data array depends on the values in
the header of <code class="docutils literal notranslate"><span class="pre">my_image.nii</span></code>.   Specifically, if the raw on-disk data type
is <code class="docutils literal notranslate"><span class="pre">np.int16</span></code> (it often is) and the header scalefactor values are default (1
for slope, 0 for intercept) then you will get back an array of the on-disk
data type - here <code class="docutils literal notranslate"><span class="pre">np.int16</span></code>.</p>
<p>This is very efficient in terms of memory, but it can be a real trap unless
you are careful.</p>
<p>For example, let’s say you had a pipeline where you did this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">sum</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
<p>That would work fine most of the time, when the data on disk is
floating point, or the scalefactors are not default (1, 0).   Then one
day, you get an image with <code class="docutils literal notranslate"><span class="pre">int16</span></code> data type on disk and (1, 0)
scalefactors, and your <cite>sum</cite> calculation is now being done in int16, and
silently overflows.  I (MB) ran into this when teaching - I had to cast some
image arrays to floating point to get sensible answers.</p>
</section>
<section id="current-implementation">
<h3>Current implementation<a class="headerlink" href="#current-implementation" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">get_data</span></code> has the following implementation, at time of writing:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return image data from image with any necessary scalng applied</span>

<span class="sd">    If the image data is a array proxy (data not yet read from disk) then</span>
<span class="sd">    read the data, and store in an internal cache.  Future calls to</span>
<span class="sd">    ``get_data`` will return the cached copy.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    data : array</span>
<span class="sd">        array of image data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_cache</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataobj</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_cache</span>
</pre></div>
</div>
<p>Note that:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">self._dataobj</span></code> may well be an array proxy object;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">np.asanyarray</span></code> forces the read of an array proxy object into a numpy
array;</p></li>
<li><p>the read also fills an internal cache.</p></li>
</ul>
</section>
</section>
<section id="proposal-add-prefer-get-fdata-method">
<h2>Proposal - add, prefer <code class="docutils literal notranslate"><span class="pre">get_fdata</span></code> method<a class="headerlink" href="#proposal-add-prefer-get-fdata-method" title="Link to this heading">¶</a></h2>
<p>The future default behavior of nibabel should be to do the thing least likely
to trip you up by accident.  But - we do not want the result of <code class="docutils literal notranslate"><span class="pre">get_data</span></code>
to change silently between nibabel versions.</p>
<ul>
<li><p>step 1: now - add <code class="docutils literal notranslate"><span class="pre">get_fdata</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_fdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return floating point image data with necessary scalng applied.</span>

<span class="sd">    If the image data is an array proxy (data not yet read from disk) then</span>
<span class="sd">    read the data from file, and retain the result in an internal cache.</span>
<span class="sd">    Future calls to ``get_fdata`` on the same image instance will return</span>
<span class="sd">    the cached copy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dtype : numpy dtype specifier</span>
<span class="sd">        A numpy dtype specifier specifying a floating point type.  Data is</span>
<span class="sd">        returned as this floating point type.  Default is ``np.float64``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fdata : array</span>
<span class="sd">        Array of image data of data type `dtype`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inexact</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> should be floating point type&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fdata_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fdata_cache</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataobj</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fdata_cache</span>
</pre></div>
</div>
<p>Change all instances of <code class="docutils literal notranslate"><span class="pre">get_data</span></code> in documentation to <code class="docutils literal notranslate"><span class="pre">get_fdata</span></code>.</p>
<p>Add warning about pending deprecation in <code class="docutils literal notranslate"><span class="pre">get_data</span></code> method, with
suggestion to use <code class="docutils literal notranslate"><span class="pre">get_fdata</span></code> or <code class="docutils literal notranslate"><span class="pre">np.asanyarray(img.dataobj)</span></code> if you
want the previous behavior, on the lines of:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>We recommend you use the ``get_fdata`` method instead of the ``get_data``
method, because it is easier to predict the return data type.  We will
deprecate the ``get_data`` method around April 2018, and remove it around
April 2020.

If you don&#39;t care about the predictability of the return data type, and
you want the minimum possible data size in memory, you can replicate the
array that would be returned by ``img.get_data()`` by using
``np.asanyarray(img.dataobj)``.
</pre></div>
</div>
<p>Add floating point cache <code class="docutils literal notranslate"><span class="pre">self._fdata_cache</span></code> to cache cleared by
<code class="docutils literal notranslate"><span class="pre">uncache</span></code> method.</p>
</li>
<li><p>step 2: around one year from now - deprecate <code class="docutils literal notranslate"><span class="pre">get_data</span></code> method;</p></li>
<li><p>step 3: around three years from now - make <code class="docutils literal notranslate"><span class="pre">get_data</span></code> method raise an
error such as <code class="docutils literal notranslate"><span class="pre">NotImplementedError</span></code> with a helpful message, and remove
associated <code class="docutils literal notranslate"><span class="pre">self._data_cache</span></code> attribute.  Leave this error in place for
a long time, to help people porting older code.</p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2006, NiBabel developers &lt;neuroimaging@python.org&gt;.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.0.2.
    </div>
  </body>
</html>